#!/usr/bin/env ruby

require 'methadone'

class App
  include Methadone::Main
  include Methadone::CLILogging

  main do |title|
    # Get required fields and construct Jekyll compatible name
    time = Time.now
    slug = title.strip.downcase.gsub(/(&|&amp;)/, ' and ').gsub(/[\s\.\/\\]/, '-').gsub(/[^\w-]/, '').gsub(/[-_]{2,}/, '-').gsub(/^[-_]/, '').gsub(/[-_]$/, '')
    name = time.strftime("%Y-%m-%d-") + slug + '.md'

    # Get the relevant fields as a hash, delete empty fields and convert
    # to YAML for the header
    data = {
      'layout' => 'post',
      'title' => title.strip.force_encoding("UTF-8"),
      'created' => time.to_i,
      'author' => 'AuthorName',
      'profile' => '/images/authorname-profile.jpg',
      'read-time' => '3',
      'published' => options[:draft] ? false : true
    }.delete_if { |k,v| v.nil? || v == ''}.to_yaml

    # Write out the data and content to file
    File.open("_posts/#{name}", "w") do |f|
      f.puts data
      f.puts "---"
    end
    info("Created '_posts/#{name}'")
  end

  version "0.0.1"
  use_log_level_option :toggle_debug_on_signal => 'USR1'
  description "Create a blank new blog post"

  arg :title
  on('--draft', 'Set published to false')

  go!
end
